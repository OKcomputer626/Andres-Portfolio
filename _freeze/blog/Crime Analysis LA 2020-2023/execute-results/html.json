{
  "hash": "12e446fab313a1061bfec22c53156698",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Crime\"\neditor: visual\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.2     ✔ tibble    3.3.0\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.1.0     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(showtext)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: sysfonts\nLoading required package: showtextdb\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(lubridate)\nlibrary(janitor)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'janitor'\n\nThe following objects are masked from 'package:stats':\n\n    chisq.test, fisher.test\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(skimr)\nlibrary(glue)\nlibrary(ggtext)\nlibrary(scales)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'scales'\n\nThe following object is masked from 'package:purrr':\n\n    discard\n\nThe following object is masked from 'package:readr':\n\n    col_factor\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(ggTimeSeries)\nlibrary(ggh4x)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Add Google fonts\nfont_add_google(\"Oswald\", family = \"Oswald\")\nfont_add_google(\"PT Serif\", family = \"Serif\")\n\n# Add local font\nfont_add(\"Font Awesome 6 Brands\", here::here(\"fonts/otfs/Font Awesome 6 Brands-Regular-400.otf\"))\n\n# Automatically enable the use of showtext for all plots\nshowtext_auto()\n\n# Set DPI for high-resolution text rendering\nshowtext_opts(dpi = 300)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Generate a social media caption with custom colors and font styling\nsocial <- andresutils::social_caption(font_family = \"Serif\", icon_color = \"#1F51FF\", font_color = \"grey45\") \n\n# Construct the final plot caption with TidyTuesday details, data source, and social caption\ncap <- paste0(\n  \"**Source**:  Los Angeles Police Department (LAPD) | **Graphic**: \", social\n)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# crime_raw <- read_csv(\"Data/crime_2025.csv\") %>%\n#   clean_names()\n# \n# crime <- crime_raw %>%\n#   mutate(\n#     date = ymd_hms(date_occ),\n#     year = year(date),\n#     month = month(date),\n#     day = day(date),\n#     dow = wday(date, label = TRUE)\n#   ) %>%\n#   filter(\n#     year %in% c(2020:2023))\n# \n# skim(crime)\n# \n# crime <- crime %>%\n#   mutate(\n#     vict_age = if_else(vict_age == 0, NA, vict_age)\n#   ) %>%\n#   select(\n#     dr_no, date, year, month, dow, time_occ, area_name, crm_cd, crm_cd_desc, vict_age, vict_sex, vict_descent, premis_cd, premis_desc)\n# \n# write_rds(crime, \"Data/crime_2020_2023.rds\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncrime <- read_rds(here::here(\"Data/crime_2020_2023.rds\"))\n```\n:::\n\n\n\n# Monthly Trends\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- crime %>%\n  mutate(month = floor_date(as.Date(date), \"month\")) %>%  # ensure Date\n  count(month, name = \"n\")\n\n# Breaks every 3 months across the data range\nbrks <- seq(\n  floor_date(min(df$month), \"quarter\"),\n  ceiling_date(max(df$month), \"quarter\"),\n  by = \"3 months\"\n)\n\n# Labels: show \"Mon\\nYear\" only for Januaries; otherwise just \"Mon\"\nlab_fun <- function(x) {\n  ifelse(month(x) == 1, paste0(format(x, \"%b\"), \"\\n\", format(x, \"%Y\")),\n         format(x, \"%b\"))\n}\n\nhigh_point <- df %>%\n  slice_max(n, n = 1, with_ties = FALSE)\n\nlow_point <- df %>%\n  slice_min(n, n = 1, with_ties = FALSE)\n\npoint <- df %>%\n  arrange(desc(month)) %>%\n  slice(3)\n\n# Compact formatter\ncompact_fmt <- label_number(\n  accuracy = 0.1,                     # 1 decimal place\n  scale_cut = cut_short_scale()       # K, M, B suffix\n)\n\n# Build highlight list\nhighlight <- bind_rows(\n  mutate(\n    high_point,\n    label = paste0(\n      format(month, \"%b '%y\"),\n      \"<br><span style='color:#1F51FF; font-size:8pt;'>\",\n      compact_fmt(n),\n      \"</span>\"\n    )\n  ),\n  mutate(\n    low_point,\n    label = paste0(\n      format(month, \"%b '%y\"),\n      \"<br><span style='color:#1F51FF; font-size:8pt;'>\",\n      compact_fmt(n),\n      \"</span>\"\n    )\n  ),\n  mutate(\n    point,\n    label = paste0(\n      format(month, \"%b '%y\"),\n      \"<br><span style='color:#1F51FF; font-size:8pt;'>\",\n      compact_fmt(n),\n      \"</span>\"\n    )\n  )\n)\n\ny_max <- max(df$n, na.rm = TRUE)\n\ndf %>%\n  ggplot(aes(x = month, y = n)) +\n  geom_line(linewidth = 0.8, color = \"#1F51FF\") +\n  geom_area(fill = \"#1F51FF\", alpha = 0.1) +\n  geom_point(\n    data = highlight,\n    aes(x = month, y = n),\n    shape = 23,\n    color = \"#1F51FF\",\n    fill = \"#FFFFFF\",\n    size = 2.2,\n    stroke = 0.8\n  ) +\n  geom_richtext(\n    data = highlight,\n    aes(x = month, y = n, label = label),\n    vjust = -0.3,\n    hjust = 0.5,\n    color = \"grey25\",\n    family = \"Serif\",\n    fill = NA,\n    # no background box\n    label.color = NA,\n    # no border\n    size = 2.2\n  ) +\n  annotate(\n    \"text\",\n    x = as.Date(\"2020-03-15\"),\n    y = y_max * 0.60,\n    label = \"COVID-19\\nRecession\",\n    family = \"Serif\",\n    color = \"#680b42\",\n    lineheight = 1.05,\n    size = 2,\n    hjust = 0,\n    vjust = 2\n  ) +\n  annotate(\n    \"curve\",\n    x = as.Date(\"2020-04-15\"),\n    y = y_max * 0.57,\n    xend = as.Date(\"2020-04-01\"),\n    yend = y_max * 0.75,\n    curvature = -0.25,\n    linetype = \"dashed\",\n    linewidth = 0.5,\n    colour = \"#680b42\",\n    arrow = arrow(type = \"closed\", length = unit(0.08, \"in\"))\n  ) +\n  # Violent Crime Wave annotation\n  annotate(\n    \"text\",\n    x = as.Date(\"2022-03-01\"),\n    # left of the spike\n    y = y_max * 0.62,\n    # vertical placement\n    label = \"Violent crime\\npeak in 2022\",\n    family = \"Serif\",\n    color = \"#680b42\",\n    lineheight = 1.05,\n    size = 2\n  ) +\n  annotate(\n    \"curve\",\n    x = as.Date(\"2022-03-01\"),\n    y = y_max * 0.7,\n    # start near text\n    xend = as.Date(\"2022-04-01\"),\n    yend = y_max * 0.95,\n    # point to spike\n    curvature = -0.2,\n    linetype = \"dashed\",\n    colour = \"#680b42\",\n    arrow = arrow(type = \"closed\", length = unit(0.08, \"in\"))\n  ) +\n  labs(\n    title = \"Los Angeles Crime Hit a Low in 2021 Before Peaking in 2022 and Leveling Off\",\n    subtitle = \"**Monthly Reported Incidents** [LAPD Data, Jan 2020 – Dec 2023]\",\n    x = NULL,\n    y = \"Incidents\",\n    caption = cap\n  ) +\n  scale_x_date(breaks = brks,\n               labels = lab_fun,\n               expand = c(0.01, 0.01)) +\n  scale_y_continuous(labels = scales::comma, limits = c(0, 25000)) +\n  theme_minimal(base_family = \"Serif\", base_size = 7) +\n  theme(\n    plot.title = element_textbox_simple(\n      family = \"Oswald\",\n      face = \"bold\",\n      size = 14\n    ),\n    plot.subtitle = element_markdown(size = 6, margin = margin(t = 5)),\n    plot.caption = element_textbox(\n      size = 4.5,\n      color = \"grey45\",\n      hjust = 0,\n      margin = margin(t = 10)\n    ),\n    plot.caption.position = \"plot\",\n    plot.title.position = \"plot\",\n    panel.grid = element_blank(),\n    axis.ticks = element_line(color = \"grey10\", size = .3),\n    plot.margin = margin(5, 5, 5, 5)\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The `size` argument of `element_line()` is deprecated as of ggplot2 3.4.0.\nℹ Please use the `linewidth` argument instead.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](Crime-Analysis-LA-2020-2023_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_10 <- crime %>%\n  count(crm_cd_desc, name = \"crimes\") %>%\n  arrange(desc(crimes)) %>%\n  mutate(\n    maxvalue = max(crimes) * 1.05,\n    crm_cd_desc = str_to_title(crm_cd_desc)\n  ) %>%\n  slice(1:10)\n\n# get top and 2nd to compute the gap\ntop_row  <- top_10 %>% slice_max(crimes, n = 1)\nsecond   <- top_10 %>% slice_max(crimes, n = 2) %>% slice_tail(n = 1)\ngap_lab  <- label_number(scale_cut = cut_short_scale(), accuracy = 0.1)(top_row$crimes - second$crimes)\n\nannot_text <- glue(\n  \"<b><span style='color:#1F51FF'>Vehicle theft</span></b> is nearly\n           <span style='color:#1F51FF'>25K</span> cases higher<br>\n           than the <span style='color:grey70'>next most common crime</span>\"\n)\n\ntop_10 %>%\n  mutate(is_max = crimes == max(crimes)) %>%\n  ggplot(aes(\n    x = reorder(crm_cd_desc, crimes),\n    y = crimes,\n    fill = is_max\n  )) +\n  geom_col() +\n  geom_text(\n    aes(\n      y = maxvalue / 15,\n      label = label_number(scale_cut = cut_short_scale(), accuracy = 0.1)(crimes),\n      color = is_max\n    ),\n    size = 2,\n    family = \"Oswald\",\n    fontface = \"bold\"\n  ) +\n  coord_flip() +\n  scale_color_manual(values = c(\"TRUE\" = \"#FFFFFF\", \"FALSE\" = \"#000000\")) +\n  scale_fill_manual(values = c(\"TRUE\" = \"#1F51FF\", \"FALSE\" = \"grey70\")) +\n  scale_y_continuous(expand = c(0.02, 0.02)) +\n  annotate(\n    \"richtext\",\n    x = 5.5,\n    # \"Vehicle - Stolen\" after str_to_title()\n    y = top_row$crimes * 0.80,\n    # place slightly to the right of the bar\n    label = annot_text,\n    hjust = 0.5,\n    family = \"Oswald\",\n    size = 2.2,\n    fill = NA, label.color = NA\n  ) +\n  annotate(\n  \"segment\",\n  x = 6.2,                                # start at your textbox x\n  y = top_row$crimes * 0.80,            # start a bit below the textbox\n  xend = 9.3,           # end at the Vehicle - Stolen bar\n  yend = top_row$crimes * 0.75,         # just shy of the bar top\n  colour = \"grey70\",\n  linewidth = 0.6,\n  arrow = arrow(type = \"closed\", length = unit(0.18, \"cm\")),\n  lineend = \"round\"\n) +\n  labs(\n    title = \"Most Common Crimes in Los Angeles\",\n    subtitle = \"**Stolen vehicles top L.A.’s 10 most reported crimes** [LAPD Data, Jan 2020 – Dec 2023]\",\n    caption = cap,\n    x = NULL,\n    y = NULL\n  ) +\n  theme_minimal(base_family = \"Oswald\", base_size = 7) +\n  theme(\n    plot.title = element_text(size = 14, face = \"bold\"),\n    plot.title.position = \"plot\",\n    plot.subtitle = element_markdown(\n      size = 6,\n      margin = margin(t = 2, b = 5),\n      family = \"Serif\"\n    ),\n    plot.caption = element_textbox(\n      family = \"Serif\",\n      size = 4.5,\n      color = \"grey45\",\n      hjust = 0,\n      margin = margin(t = 5)\n    ),\n    plot.caption.position = \"plot\",\n    axis.text.y = element_text(hjust = 1),\n    axis.text.x = element_blank(),\n    panel.grid = element_blank(),\n    plot.margin = margin(5, 5, 5, 5),\n    legend.position = \"none\"\n  )\n```\n\n::: {.cell-output-display}\n![](Crime-Analysis-LA-2020-2023_files/figure-html/unnamed-chunk-7-1.png){width=864}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames <- crime %>%\n  filter(crm_cd_desc == \"VEHICLE - STOLEN\",\n         year == 2023) %>%\n  group_by(area_name) %>%\n  count() %>%\n  arrange(desc(n)) %>%\n  ungroup() %>%\n  slice(1:9) %>%\n  pull(area_name)\n\ndow_area <- crime %>%\n  filter(crm_cd_desc == \"VEHICLE - STOLEN\",\n         year == 2023,\n         area_name %in% names) %>%\n  group_by(dow, area_name) %>%\n  count(name = \"avg\") %>%\n  ungroup() %>%\n  group_by(area_name) %>%\n  mutate(is_max = avg == max(avg)) %>%\n  ungroup()\n\ndow_area %>%\n  ggplot(aes(x = dow, y = avg, fill = is_max)) +\n  geom_col() +\n  geom_text(data = dow_area %>% filter(is_max == \"TRUE\"), aes(label = avg), family = \"Oswald\", color = \"#FFFFFF\", size = 1.8, vjust = 1.4) +\n  facet_wrap2(vars(area_name), axes = \"all\") +\n  scale_fill_manual(values = c(\"TRUE\" = \"#1F51FF\", \"FALSE\" = \"grey70\")) +\n  labs(\n    title = \"When Are Cars Stolen Most Often in Los Angeles?\",\n    subtitle = \"**In 2023, vehicle thefts across LAPD divisions often peaked on Fridays and Saturdays.** [LAPD Data, Jan–Dec 2023]\",\n    caption = cap,\n    x = NULL,\n    y = NULL) +\n  theme_minimal(base_family = \"Oswald\", base_size = 7) +\n  theme(\n    plot.title = element_text(size = 14, face = \"bold\"),\n    plot.title.position = \"plot\",\n    plot.subtitle = element_markdown(family = \"Serif\", size = 6, margin = margin(t = 2, b = 5)),\n    plot.caption = element_textbox(\n      family = \"Serif\",\n      size = 4.5,\n      color = \"grey45\",\n      hjust = 0,\n      margin = margin(t = 10)\n    ),\n    plot.caption.position = \"plot\",\n    legend.position = \"none\",\n    panel.grid.major.x = element_blank(),\n    plot.margin = margin(5, 5, 5, 5)\n  )\n```\n\n::: {.cell-output-display}\n![](Crime-Analysis-LA-2020-2023_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndaily <- crime %>%\n  mutate(date = as_date(date)) %>%\n  count(date, name = \"incidents\")\n\ndtMonthLabels <- daily %>%\n  mutate(\n    WeekOfYear  = 1 + as.integer(strftime(date, \"%W\")),\n    MonthOfYear = as.integer(strftime(date, \"%m\"))\n  ) %>%\n  group_by(MonthOfYear) %>%\n  summarise(meanWeekOfYear = mean(WeekOfYear), .groups = \"drop\") %>%\n  mutate(MonthOfYear = month.abb[MonthOfYear])\n\nggplot_calendar_heatmap(\n  dtDateValue = daily,\n  cDateColumnName = \"date\",\n  cValueColumnName = \"incidents\",\n  monthBorderSize = 1\n) +\n  scale_fill_gradient(low = \"#FFFFFF\", high = \"#1F51FF\",\n                      guide = guide_colorbar(\n                        direction = \"horizontal\",\n                        barheight = unit(0.25, \"cm\"),\n                        barwidth = unit(4, \"cm\"),\n                        label.vjust = 0.5\n                      )) +\n  labs(\n    title = \"Los Angeles Crime\",\n    subtitle = \"Daily incident counts\",\n    caption = cap,\n    x = NULL,\n    y = NULL,\n    fill = NULL\n  ) +\n  facet_wrap(vars(Year),\n             ncol = 1,\n             axes = \"all\",\n             strip.position = \"left\") +\n  scale_x_continuous(\n    breaks   = dtMonthLabels$meanWeekOfYear,\n    labels   = dtMonthLabels$MonthOfYear,\n    expand   = c(0, 0),\n    position = \"top\"\n  ) +\n  theme_minimal(base_size = 7, base_family = \"Serif\") +\n  theme(\n    plot.title = element_text(family = \"Oswald\", face = \"bold\"),\n    plot.caption = element_textbox(\n      hjust = 0,\n      size = 4.5,\n      color = \"grey45\"\n    ),\n    plot.caption.position = \"plot\",\n    legend.position = \"bottom\",\n    strip.placement = \"outside\",\n    strip.text = element_text(\n      size = 10,\n      family = \"Oswald\",\n      color = \"grey75\"\n    ),\n    axis.ticks = element_blank(),\n    panel.grid = element_blank(),\n    plot.title.position = \"plot\",\n    legend.ticks = element_blank(),\n    plot.margin = margin(5, 5, 5, -10)\n  ) \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nScale for x is already present.\nAdding another scale for x, which will replace the existing scale.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](Crime-Analysis-LA-2020-2023_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n",
    "supporting": [
      "Crime-Analysis-LA-2020-2023_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}